---
# Kernel
- name: Restrict access to kernel logs
  command: echo "kernel.dmesg_restrict = 1" > /etc/sysctl.d/50-dmesg-restrict.conf

- name: Restrict access to kernel pointers
  command: echo "kernel.kptr_restrict = 1" > /etc/sysctl.d/50-kptr-restrict.conf

- name: ExecShield Protection
  command: echo "kernel.exec-shield = 2" > /etc/sysctl.d/50-exec-shield.conf

- name: Randomize memory space
  command: echo "kernel.randomize_va_space=2" > /etc/sysctl.d/50-rand-va-space.conf

# Logging

- name: Ensure syslog is enabled and running
  ansible.builtin.systemd_service:
    state: started
    name: rsyslog

# Login access
- name: auto logout inactive users step 1 / 3
  ansible.builtin.lineinfile:
    path: /etc/profile.d/idle-users.sh
    line: "readonly TMOUT=900"
    state: present
    create: true

- name: auto logout inactive users step 2 / 3
  ansible.builtin.lineinfile:
    path: /etc/profile.d/idle-users.sh
    line: "readonly HISTFILE"
    state: present
    create: true

- name: auto logout inactive users step 3 / 3
  command: chmod +x /etc/profile.d/idle-users.sh

- name: Add faillock preauth 1 / 3 (Deny after x)
  lineinfile:
    path: /etc/security/faillock.conf
    regexp: '^#?\s*deny\s*='
    line: 'deny = 10'
    create: yes
    owner: root
    group: root
    mode: '0644'

- name: Add faillock preauth 2 / 3 (cooldown)
  lineinfile:
    path: /etc/security/faillock.conf
    regexp: '^#?\s*unlock_time\s*='
    line: 'unlock_time = 900'

- name: Add faillock preauth 3 / 3 (intervall)
  lineinfile:
    path: /etc/security/faillock.conf
    regexp: '^#?\s*fail_interval\s*='
    line: 'fail_interval = 900'

- name: Enable faillock PAM profile
  ansible.builtin.command: pam-auth-update --enable faillock --force
  changed_when: false

# File system
- name: Hard link protection
  command: echo "fs.protected_hardlinks = 1" > /etc/sysctl.d/50-fs-hardening.conf

- name: Soft link protection
  command: echo "fs.protected_symlinks = 1" >> /etc/sysctl.d/50-fs-hardening.conf

- name: Disable uncommon file systems
  command: "echo install {{ item }} /bin/false > /etc/modprobe.d/uncommon-fs.conf"
  loop: "{{ filesystems }}"

# Permissions
- name: SELinux Enforcing
  ansible.builtin.lineinfile:
    path: /etc/selinux/config
    line: "SELINUXTYPE=enforcing"
    state: present
    create: true

# Networking

- name: TCP SYN Cookie protection
  command: echo "net.ipv4.tcp_syncookies = 1" > /etc/sysctl.d/50-net-stack.conf

- name: Disable IP source routing
  command: echo "net.ipv4.conf.all.accept_source_route = 0" > /etc/sysctl.d/50-net-stack.conf

- name: Disable ICMP Protocol
  command: echo "net.ipv4.conf.all.accept_redirects = 0" > /etc/sysctl.d/50-net-stack.conf

- name: Enable ignoring of ICMP requests
  command: echo "net.ipv4.icmp_echo_ignore_all = 1" > /etc/sysctl.d/50-net-stack.conf

- name: Ignore broadcast request
  command: echo "net.ipv4.icmp_echo_ignore_broadcasts = 1" > /etc/sysctl.d/50-net-stack.conf